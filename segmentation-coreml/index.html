<!DOCTYPE html>
<html lang="default">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16.png">
  <link rel="mask-icon" href="/images/safari-pinned-tab.svg" color="#222">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">
  <meta name="google-site-verification" content="dEKIskZSG1sj_B105kZnKupOw7mKVCXsSrXXim-FhqI">
  <meta name="msvalidate.01" content="9896C95C563A05172CD78265E4243404">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"frost-lee.github.io","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"hide","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Core ML offers a great way for conducting machine learning on Apple devices. Developers could download existing Core ML models from various sources such as here or train a model from various templates">
<meta property="og:type" content="article">
<meta property="og:title" content="On-Device Semantic Segmentation with Core ML">
<meta property="og:url" content="https://frost-lee.github.io/segmentation-coreml/index.html">
<meta property="og:site_name" content="Frost&#39;s Blog">
<meta property="og:description" content="Core ML offers a great way for conducting machine learning on Apple devices. Developers could download existing Core ML models from various sources such as here or train a model from various templates">
<meta property="og:locale">
<meta property="og:image" content="http://209.250.236.3:1910/bloghost/KJiNRkyCytwZ6K7bTFUxvL.png">
<meta property="article:published_time" content="2021-02-12T05:09:16.000Z">
<meta property="article:modified_time" content="2021-03-11T13:52:55.166Z">
<meta property="article:author" content="Frost Lee">
<meta property="article:tag" content="iOS">
<meta property="article:tag" content="Machine Learning">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://209.250.236.3:1910/bloghost/KJiNRkyCytwZ6K7bTFUxvL.png">

<link rel="canonical" href="https://frost-lee.github.io/segmentation-coreml/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'default'
  };
</script>

  <title>On-Device Semantic Segmentation with Core ML | Frost's Blog</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-139409052-1"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-139409052-1');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Frost's Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Frost's Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Frost's Blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="default">
    <link itemprop="mainEntityOfPage" href="https://frost-lee.github.io/segmentation-coreml/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/Avatar.png">
      <meta itemprop="name" content="Frost Lee">
      <meta itemprop="description" content="Civilize the age.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Frost's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          On-Device Semantic Segmentation with Core ML
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-02-12 13:09:16" itemprop="dateCreated datePublished" datetime="2021-02-12T13:09:16+08:00">2021-02-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2021-03-11 21:52:55" itemprop="dateModified" datetime="2021-03-11T21:52:55+08:00">2021-03-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Software-Developing/" itemprop="url" rel="index"><span itemprop="name">Software Developing</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>Core ML offers a great way for conducting machine learning on Apple devices. Developers could download existing Core ML models from various sources such as <a target="_blank" rel="noopener external nofollow noreferrer" href="https://developer.apple.com/machine-learning/models/">here</a> or train a model from various templates in CreateML. For more flexibility, they could also train a model with other frameworks and convert it to Core ML. This article records my experiment on conducting on-device semantic segmentation by converting a Keras model to Core ML.<a id="more"></a> The goal of the demo in this article aimed at creating a proof-of-concept application that segments the liver's region in CT scanning images.</p>
<p>Some Python package synonyms are given as follows.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> coremltools <span class="keyword">as</span> ct</span><br><span class="line"><span class="keyword">import</span> imgaug.augmenters <span class="keyword">as</span> iaa</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> segmentation_models <span class="keyword">as</span> sm</span><br><span class="line"><span class="keyword">import</span> tensorflow <span class="keyword">as</span> tf</span><br></pre></td></tr></table></figure>
<h1 id="semantic-segmentation-model-with-keras">Semantic Segmentation Model with Keras</h1>
<p>In semantic segmentation tasks, the machine learning model gives a segmentation mask from its input. The segmentation mask has the same resolution as the model's input. In its channel dimension, elements of each vector represent the probability of the corresponding pixel in the input image belonging to the class. The liver segmentation task only has one class output: liver. Thus, with the input image's resolution being 512 x 512, the output's shape is <code>(512, 512, 1)</code>.</p>
<h2 id="data-generator">Data Generator</h2>
<p>In most machine learning frameworks, training is done in batches and epochs. A batch is a small group of data feeds to the model, providing a reference on optimizing the model's parameters. And an epoch contains all batches that cover the entire training set. You could load the entire dataset and feed it to Keras using the <code>fit</code> method and let it split the dataset into batches for you. However, the dataset could be too large to be loaded entirely sometimes. In such cases, we could provide Keras a generator alternatively. The generator provides a tuple containing a batch of corresponding samples and labels in each iteration. We need to manually specify the number of batches in an epoch in the <code>fit_generator</code> method to split the epochs accordingly.</p>
<p>I'm also adding data augmentation using <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/aleju/imgaug">imgaug</a> at this stage. The augmentation would augment the image and segmentation mask simultaneously, making them look different to the model every time, thus reduce the chance for overfitting during training.</p>
<p>Although the CT scanning images are single-channel, 3-channel image representation (initial values are duplicated to 3 channels, rescaled to 0 - 255, then normalized to 0 - 1) is used here since I'm not sure whether it's okay to keep single-channel images on iOS albums. Finally, in each iteration, <code>data_generator</code> yields images with shape <code>(BATCH_SIZE, 512, 512, 3)</code> with each element range from 0 to 1, and labels with shape <code>(BATCH_SIZE, 512, 512)</code>. Related code is shown as follows.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">rescale</span>(<span class="params">grey_scale_image</span>):</span></span><br><span class="line">    numerical_range = np.<span class="built_in">max</span>(grey_scale_image) - np.<span class="built_in">min</span>(grey_scale_image)</span><br><span class="line">    relative_values = grey_scale_image - np.<span class="built_in">min</span>(grey_scale_image)</span><br><span class="line">    <span class="keyword">return</span> (relative_values / numerical_range * <span class="number">255.0</span>).astype(<span class="string">&#x27;uint8&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">data_generator</span>():</span></span><br><span class="line">    aug_seq = iaa.Sequential([</span><br><span class="line">        iaa.Affine(scale=&#123;<span class="string">&#x27;x&#x27;</span>: (<span class="number">0.5</span>, <span class="number">1.5</span>), <span class="string">&#x27;y&#x27;</span>: (<span class="number">0.5</span>, <span class="number">1.5</span>)&#125;,</span><br><span class="line">        translate_percent=&#123;<span class="string">&#x27;x&#x27;</span>: (<span class="number">-0.5</span>, <span class="number">0.5</span>), <span class="string">&#x27;y&#x27;</span>: (<span class="number">-0.5</span>, <span class="number">0.5</span>)&#125;,</span><br><span class="line">        rotate=(<span class="number">-180</span>, <span class="number">180</span>))</span><br><span class="line">    ])</span><br><span class="line">    dataset_archive_paths = [os.path.join(</span><br><span class="line">        DATASET_VOLUME_ROOT_PATH,</span><br><span class="line">        DATASET_VOLUME_NAME_PREFIX + <span class="built_in">str</span>(index) + <span class="string">&#x27;.&#x27;</span> + DATASET_VOLUME_NAME_SURFIX</span><br><span class="line">    ) <span class="keyword">for</span> index <span class="keyword">in</span> DATASET_VOLUME_INDEX_RANGE]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_mat</span>(<span class="params">path</span>):</span></span><br><span class="line">        <span class="keyword">return</span> scipy.io.loadmat(path)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        random.shuffle(dataset_archive_paths)</span><br><span class="line">        <span class="keyword">for</span> path <span class="keyword">in</span> dataset_archive_paths:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(path):</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            mat = get_mat(path)</span><br><span class="line">            images, tumor_seg_masks = <span class="built_in">tuple</span>(<span class="built_in">map</span>(</span><br><span class="line">                <span class="keyword">lambda</span> x: np.expand_dims(np.transpose(mat[x], axes=(<span class="number">2</span>, <span class="number">0</span>, <span class="number">1</span>)), axis=<span class="number">-1</span>),</span><br><span class="line">                [<span class="string">&#x27;image&#x27;</span>, <span class="string">&#x27;liver&#x27;</span>]</span><br><span class="line">            ))</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(DATASET_VOLUME_SIZE // BATCH_SIZE):</span><br><span class="line">                start_index, end_index = i * BATCH_SIZE, (i + <span class="number">1</span>) * BATCH_SIZE</span><br><span class="line">                imgs, msks = aug_seq(</span><br><span class="line">                    images=images[start_index : end_index],</span><br><span class="line">                    segmentation_maps=tumor_seg_masks[start_index : end_index]</span><br><span class="line">                )</span><br><span class="line">                imgs = np.array([*<span class="built_in">map</span>(</span><br><span class="line">                    <span class="keyword">lambda</span> x: np.stack([rescale(np.squeeze(x))] * <span class="number">3</span>,</span><br><span class="line">                    axis=<span class="number">-1</span></span><br><span class="line">                ), imgs)]).astype(<span class="string">&#x27;float32&#x27;</span>)</span><br><span class="line">                imgs /= <span class="number">255.0</span></span><br><span class="line">                <span class="keyword">yield</span> imgs, np.squeeze(msks).astype(<span class="string">&#x27;float32&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="model-architecture">Model Architecture</h2>
<p>There are lots of model architectures that tackles the problem of semantic segmentation, including but not limited to U-Net, Mask-RCNN, and DeepLab. In the Python package <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/qubvel/segmentation_models">segmentation models</a>, you could get easy access to multiple model architectures. By simply specifying the input shape, class count, and possibly model backbone (feature extractor architecture), you can get the Keras model for semantic segmentation with one single line of code. In this article, I'm using U-Net model with ResNet backbone. Since CT scanning images are visually different from normal images by a lot, I'm not adopting the pre-trained weights.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">unet_model = sm.Unet(</span><br><span class="line">    backbone_name=<span class="string">&#x27;resnet50&#x27;</span>,</span><br><span class="line">    input_shape=(<span class="number">512</span>, <span class="number">512</span>, <span class="number">3</span>),</span><br><span class="line">    encoder_weights=<span class="literal">None</span>,</span><br><span class="line">    classes=<span class="number">1</span>,</span><br><span class="line">    activation=<span class="string">&#x27;sigmoid&#x27;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h2 id="model-training">Model Training</h2>
<p>I am using binary cross entropy with Adam optimizer in the training phase. Both are traditional selections. However, due to the unbalanced class distribution problem, binary cross entropy may not be the ideal selection all the time. If time allows, you could try other loss functions such as Jaccard, dice, or Lovasz hinge. These loss functions use the overlap between the ground truth and prediction as their measures, thus alleviates the class unbalance problem.</p>
<p>In the <code>fit_generator</code> method, I'm using two callbacks: learning rate scheduler and model checkpoint. The learning rate scheduler could decay the learning rate after certain numbers of epochs, and the model checkpoint could dump the model after each epoch. These callbacks could help achieve better model performance and select the model with best-fit.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">unet_model.<span class="built_in">compile</span>(</span><br><span class="line">    optimizer=tf.keras.optimizers.Adam(),</span><br><span class="line">    loss=tf.keras.losses.binary_crossentropy,</span><br><span class="line">    metrics=[sm.metrics.IOUScore(threshold=<span class="number">0.5</span>), <span class="string">&#x27;accuracy&#x27;</span>]</span><br><span class="line">)</span><br><span class="line">unet_model.fit_generator(</span><br><span class="line">    data_generator(),</span><br><span class="line">    epochs=<span class="number">16</span>,</span><br><span class="line">    steps_per_epoch=<span class="built_in">len</span>(DATASET_VOLUME_INDEX_RANGE) * DATASET_VOLUME_SIZE // BATCH_SIZE,</span><br><span class="line">    callbacks=[</span><br><span class="line">        tf.keras.callbacks.LearningRateScheduler(<span class="keyword">lambda</span> ei, lr: lr / <span class="number">2.0</span> <span class="keyword">if</span> ei &gt; <span class="number">0</span> <span class="keyword">and</span> (ei / <span class="number">2</span>).is_integer() <span class="keyword">else</span> lr),</span><br><span class="line">        tf.keras.callbacks.ModelCheckpoint(os.path.join(MODEL_ARCHIVE_PATH, <span class="string">&#x27;model_checkpoint_&#123;epoch:02d&#125;.hdf5&#x27;</span>), period=<span class="number">1</span>)</span><br><span class="line">    ]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h1 id="converting-to-core-ml">Converting to Core ML</h1>
<p>When the training process is finished, you can choose the dumped checkpoint file with the best evaluation performance. The checkpoint can be loaded by Keras in the future. To perform predictions on Core ML, a Core ML format file (file with .mlmodel extension) is required. Apple provides <a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/apple/coremltools">coremltools</a> for converting models with other types to Core ML's format. The following script help loads the Keras model checkpoint, convert to Core ML format, and dump the converted model. As image inputs from users' albums have integer pixel values from 0 to 255, the corresponding scale is specified to help the model get its correct input.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">keras_model = tf.keras.models.load_model(</span><br><span class="line">    keras_model_path,</span><br><span class="line">    custom_objects=&#123;</span><br><span class="line">        <span class="string">&#x27;iou_score&#x27;</span>: tf.keras.losses.binary_crossentropy</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line">coreml_model = ct.convert(</span><br><span class="line">    keras_model,</span><br><span class="line">    inputs=[ct.ImageType(shape=(<span class="number">1</span>, <span class="number">512</span>, <span class="number">512</span>, <span class="number">3</span>), bias=[<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>], scale=<span class="number">1.0</span> / <span class="number">255.0</span>)]</span><br><span class="line">)</span><br><span class="line">coreml_model.save(coreml_model_output_path)</span><br></pre></td></tr></table></figure>
<h1 id="on-device-prediction-and-visualization">On-Device Prediction and Visualization</h1>
<p>The final result of the previous steps is the Core ML format model file, which could help us perform on-device machine learning. With on-device machine learning, the application could have less dependency on the internet connection, be more responsive, and keep the user's data on their devices.</p>
<h2 id="prediction-pipeline">Prediction Pipeline</h2>
<p>After dragging the model file to the Xcode project, Xcode automatically generates its model class with the name identical to the model file's name. The model class serves as the initializer for the <code>VNCoreMLModel</code> class, a container for a Core ML model used with Vision requests. This class receives <code>VNCoreMLRequest</code> and generates <code>VNObservation</code>. During the initialization of the <code>VNCoreMLRequest</code>, one states the callback for handling the prediction result of the model. The related initialization code is given as follows.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">setupModels</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">let</span> modelConfiguration: <span class="type">MLModelConfiguration</span> = &#123;</span><br><span class="line">        <span class="keyword">let</span> config = <span class="type">MLModelConfiguration</span>()</span><br><span class="line">        config.computeUnits = .cpuAndGPU</span><br><span class="line">        <span class="keyword">return</span> config</span><br><span class="line">    &#125;()</span><br><span class="line">    liverSegmentationModel = <span class="keyword">try</span>! <span class="type">VNCoreMLModel</span>(<span class="keyword">for</span>: liver_segmentation(configuration: modelConfiguration).model)</span><br><span class="line">    liverSegmentationRequest = <span class="type">VNCoreMLRequest</span>(model: liverSegmentationModel!) &#123; (request, error) <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">self</span>.observationResults = request.results <span class="keyword">as</span>? [<span class="type">VNObservation</span>]</span><br><span class="line">        <span class="keyword">self</span>.isProcessing = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    liverSegmentationRequest?.imageCropAndScaleOption = .centerCrop</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><strong>Note</strong>: The default <code>MLModelConfiguration</code> is recommended in most of the cases, which could fully utilize on-device computing resources such as the CPU, GPU, and NPU. However, as these devices adopt different float point prevision, the prediction result could be different. If you find the result strange, try to modify <code>computeUnits</code> in the configuration.</p>
</blockquote>
<p>The model's input is represented as a <code>CGImage</code>, then wrapped as a <code>VNImageRequestHandler</code>. The prediction is made in a separate queue in order to prevent the logic from blocking the UI updates. The prediction result will be provided in the corresponding <code>VNCoreMLRequest</code> object's callback.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> mlProcessingQueue = <span class="type">DispatchQueue</span>(label: <span class="string">&quot;ml_processing&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">performAnalysis</span><span class="params">()</span></span> &#123;</span><br><span class="line">    isProcessing = <span class="literal">true</span></span><br><span class="line">    mlProcessingQueue.async &#123;</span><br><span class="line">        <span class="keyword">let</span> handler = <span class="type">VNImageRequestHandler</span>(cgImage: <span class="keyword">self</span>.ctScanImage!.cgImage!, options: [:])</span><br><span class="line">      	<span class="keyword">try</span>! handler.perform([<span class="keyword">self</span>.liverSegmentationRequest!])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="result-visualization">Result Visualization</h2>
<p><code>VNObservation</code> is a generic type for prediction outputs in Vision. For semantic segmentation, we need to downcast the <code>VNObservation</code> object to <code>VNCoreMLFeatureValueObservation</code>, which contains the segmentation mask as an <code>MLMultiArray</code>. In our case, the segmentation model's output has the shape <code>(1, 512, 512, 1)</code>. The specific probability prediction for each pixel can be fetched as follows.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">segmentationSubscript</span><span class="params">(array: MLMultiArray, columnIndex: Int, rowIndex: Int)</span></span> -&gt; <span class="type">NSNumber</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> height = array.shape[<span class="number">1</span>].intValue</span><br><span class="line">    <span class="keyword">return</span> array[columnIndex * height + rowIndex]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>For visualization, I used Quart2D. By overlaying another transparent view over the image view showing the original image, then draw a rectangle for each value in the prediction mask with the alpha value being the corresponding probability, we could visualize the model's prediction result.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ObservationVisualizerView</span>: <span class="title">UIView</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> highlightColors: [<span class="type">UIColor</span>] = []    <span class="comment">// fill some color literals</span></span><br><span class="line">    <span class="keyword">var</span> observations: [<span class="type">VNObservation</span>]? &#123;</span><br><span class="line">        <span class="keyword">didSet</span> &#123;</span><br><span class="line">            <span class="keyword">guard</span> observations != <span class="literal">nil</span> <span class="keyword">else</span> &#123;<span class="keyword">return</span>&#125;</span><br><span class="line">            <span class="keyword">self</span>.setNeedsDisplay()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">willMove</span><span class="params">(toSuperview newSuperview: UIView?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.willMove(toSuperview: newSuperview)</span><br><span class="line">        backgroundColor = .clear</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SegmentationMaskVisualizerView</span>: <span class="title">ObservationVisualizerView</span> </span>&#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">draw</span><span class="params">(<span class="number">_</span> rect: CGRect)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.draw(rect)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> featureValueObservation = observations <span class="keyword">as</span>? [<span class="type">VNCoreMLFeatureValueObservation</span>] &#123;</span><br><span class="line">            <span class="keyword">guard</span> featureValueObservation.<span class="built_in">count</span> &gt; <span class="number">0</span> <span class="keyword">else</span> &#123;<span class="keyword">return</span>&#125;</span><br><span class="line">            <span class="keyword">let</span> segmentationMap = featureValueObservation.first!.featureValue.multiArrayValue!</span><br><span class="line">            <span class="keyword">let</span> context = <span class="type">UIGraphicsGetCurrentContext</span>()</span><br><span class="line">            context?.clear(rect)</span><br><span class="line">            <span class="keyword">let</span> segmentationMapWidth = segmentationMap.shape[<span class="number">1</span>].intValue</span><br><span class="line">            <span class="keyword">let</span> segmentationMapHeight = segmentationMap.shape[<span class="number">2</span>].intValue</span><br><span class="line">            <span class="keyword">let</span> widthScale = bounds.width / <span class="type">CGFloat</span>(segmentationMapWidth)</span><br><span class="line">            <span class="keyword">let</span> heightScale = bounds.height / <span class="type">CGFloat</span>(segmentationMapHeight)</span><br><span class="line">            <span class="keyword">for</span> rowIndex <span class="keyword">in</span> <span class="number">0</span> ..&lt; segmentationMapHeight &#123;</span><br><span class="line">                <span class="keyword">for</span> columnIndex <span class="keyword">in</span> <span class="number">0</span> ..&lt; segmentationMapWidth &#123;</span><br><span class="line">                    <span class="type">UIColor</span>(</span><br><span class="line">                        red: <span class="number">1.0</span>,</span><br><span class="line">                        green: <span class="number">0.0</span>,</span><br><span class="line">                        blue: <span class="number">0.0</span>,</span><br><span class="line">                        alpha: <span class="type">CGFloat</span>(segmentationSubscript(array: segmentationMap, columnIndex: columnIndex, rowIndex: rowIndex).doubleValue)</span><br><span class="line">                    ).setFill()</span><br><span class="line">                    <span class="type">UIRectFill</span>(<span class="type">CGRect</span>(</span><br><span class="line">                        x: heightScale * <span class="type">CGFloat</span>(rowIndex),</span><br><span class="line">                        y: widthScale * <span class="type">CGFloat</span>(columnIndex),</span><br><span class="line">                        width: heightScale,</span><br><span class="line">                        height: widthScale</span><br><span class="line">                    ))</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Here's a screenshot of the final application.</p>
<p><img src="http://209.250.236.3:1910/bloghost/KJiNRkyCytwZ6K7bTFUxvL.png" alt="result" /></p>

    </div>

    
    
    

      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/iOS/" rel="tag"># iOS</a>
              <a href="/tags/Machine-Learning/" rel="tag"># Machine Learning</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/macos-python/" rel="prev" title="Python Interpreter on macOS">
      <i class="fa fa-chevron-left"></i> Python Interpreter on macOS
    </a></div>
      <div class="post-nav-item">
    <a href="/2021-application-season/" rel="next" title="聊一聊 2021 年的申请季">
      聊一聊 2021 年的申请季 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#semantic-segmentation-model-with-keras"><span class="nav-number">1.</span> <span class="nav-text">Semantic Segmentation Model with Keras</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#data-generator"><span class="nav-number">1.1.</span> <span class="nav-text">Data Generator</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#model-architecture"><span class="nav-number">1.2.</span> <span class="nav-text">Model Architecture</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#model-training"><span class="nav-number">1.3.</span> <span class="nav-text">Model Training</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#converting-to-core-ml"><span class="nav-number">2.</span> <span class="nav-text">Converting to Core ML</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#on-device-prediction-and-visualization"><span class="nav-number">3.</span> <span class="nav-text">On-Device Prediction and Visualization</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#prediction-pipeline"><span class="nav-number">3.1.</span> <span class="nav-text">Prediction Pipeline</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#result-visualization"><span class="nav-number">3.2.</span> <span class="nav-text">Result Visualization</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Frost Lee"
      src="/images/Avatar.png">
  <p class="site-author-name" itemprop="name">Frost Lee</p>
  <div class="site-description" itemprop="description">Civilize the age.</div>
</div>


   <div class="feed-link motion-element">
     <a href="/atom.xml" rel="alternate">
       <i class="fa fa-rss"></i>
       RSS
     </a>
   </div>
 
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">19</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">7</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">20</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Frost-Lee" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Frost-Lee" rel="noopener external nofollow noreferrer" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://stackoverflow.com/users/10068755/frost-lee" title="StackOverflow → https:&#x2F;&#x2F;stackoverflow.com&#x2F;users&#x2F;10068755&#x2F;frost-lee" rel="noopener external nofollow noreferrer" target="_blank"><i class="fab fa-stack-overflow fa-fw"></i>StackOverflow</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:contact.FrostLee@gmail.com" title="E-Mail → mailto:contact.FrostLee@gmail.com" rel="noopener external nofollow noreferrer" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2019 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-snowflake"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Frost Lee</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@2/MathJax.js?config=TeX-AMS-MML_HTMLorMML';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

<script type="text/x-mathjax-config">
   MathJax.Hub.Config({
       TeX: {equationNumbers: {autoNumber: ["AMS"], useLabelIds: true}},
       "HTML-CSS": {linebreaks: {automatic: true}},
       SVG: {linebreaks: {automatic: true}}
   });
</script>

    

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '13c40b3687a06d2c9a84',
      clientSecret: '3ce983fcf815d6ee689b8e00d1bec23a7973c396',
      repo        : 'Frost-Lee.github.io',
      owner       : 'Frost-Lee',
      admin       : ['Frost-Lee'],
      id          : '/segmentation-coreml/',
        language: 'en',
      distractionFreeMode: true,
      proxy: 'http://209.250.236.3:8080/https://github.com/login/oauth/access_token'
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
